<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - glTF loader</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" href="map.css">
		<link type="text/css" rel="stylesheet" href="main.css">
	</head>

	<body class="map">
		<!-- <div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> - GLTFLoader<br />
			Battle Damaged Sci-fi Helmet by
			<a href="https://sketchfab.com/theblueturtle_" target="_blank" rel="noopener">theblueturtle_</a><br />
			<a href="https://hdrihaven.com/hdri/?h=royal_esplanade" target="_blank" rel="noopener">Royal Esplanade</a> by <a href="https://hdrihaven.com/" target="_blank" rel="noopener">HDRI Haven</a>
		</div> -->
		<div id="map_container" class="map_container">
			<div id="map-viewport_container" class="map-viewport_container">

			</div>

			<div class="map-area-panel">
				<div id="description_container" class="map-area-info">
					Lorem ipsum dolor sit amet, consectetur adipisicing elit. 
					Vero animi voluptatem suscipit laborum temporibus, laboriosam modi consequatur quae ipsam dolor accusantium, 
					error facere quo maiores iste similique necessitatibus voluptates sunt.
				</div>
				<div class="map-area-buttons">
					<button id="but1" class="map-button">Area 1</button>
					<button id="but2" class="map-button">Area 2</button>
					<button id="but3" class="map-button">Area 3</button>
				</div>
				<!-- <input type="text" name="" id="x" value="x: ">
				<input type="text" name="" id="y" value="y: ">
				<input type="text" name="" id="z" value="z: "> -->
				<div id="area-1_description" style="display: none;">
					<h2>Area 1</h2><br>
					Lorem ipsum dolor sit amet consectetur adipisicing elit. Dolores a aperiam iusto. Tempora, mollitia. <br>
					Lorem ipsum dolor sit?
				</div>
				<div id="area-2_description" style="display: none;">
					<h2>Area 2</h2><br>
					Lorem ipsum dolor sit amet consectetur adipisicing elit. Quibusdam doloribus ab facere sunt a doloremque repudiandae eveniet unde dolorem, laborum maiores enim?
				</div>
				<div id="area-3_description" style="display: none;">
					<h2>Area 3</h2><br>
					Lorem ipsum dolor sit amet consectetur adipisicing elit. Porro harum doloremque tempora dolore reiciendis numquam id perspiciatis nemo. <br>
					Lorem ipsum dolor sit amet consectetur.
				</div>
			</div>
		</div>	
		

	</body>
	<script type="module">

		import * as THREE from '../build/three.module.js';

		import { OrbitControls } from './jsm/controls/OrbitControls.js';
		import { FlyControls } from './jsm/controls/FlyControls.js';
		import { GLTFLoader } from './jsm/loaders/GLTFLoader.js';
		import { RGBELoader } from './jsm/loaders/RGBELoader.js';
		import { RoughnessMipmapper } from './jsm/utils/RoughnessMipmapper.js';
		
		let camera, controls, scene, renderer;

		let viewport_container, feature_container;
		let button1, button2, button3

		let widthOffset = 10;

		button1 = document.querySelector("#but1");
		button2 = document.querySelector("#but2");
		button3 = document.querySelector("#but3");


		init();
		render();

		function init() {

			// const viewport_container = document.createElement( 'div' );
			// document.body.appendChild( viewport_container );

			// document.querySelector("#main").appendChild( viewport_container );

			viewport_container = document.querySelector("#map-viewport_container");
			feature_container = document.querySelector("#map_container");

			camera = new THREE.PerspectiveCamera( 45, (viewport_container.offsetWidth - widthOffset) / viewport_container.offsetHeight, 0.25, 20 );
			camera.position.set( - 1.8, 0.6, 2.7 );

			scene = new THREE.Scene();

			new RGBELoader()
				.setDataType( THREE.UnsignedByteType )
				.setPath( 'textures/equirectangular/' )
				.load( 'royal_esplanade_1k.hdr', function ( texture ) {

					const envMap = pmremGenerator.fromEquirectangular( texture ).texture;

					scene.background = envMap;
					scene.environment = envMap;

					texture.dispose();
					pmremGenerator.dispose();

					render();

					// model

					// use of RoughnessMipmapper is optional
					const roughnessMipmapper = new RoughnessMipmapper( renderer );

					const loader = new GLTFLoader().setPath( 'models/gltf/test_model/' );
					loader.load( 'test_model.glb', function ( gltf ) {

						gltf.scene.traverse( function ( child ) {

							if ( child.isMesh ) {

								// TOFIX RoughnessMipmapper seems to be broken with WebGL 2.0
								// roughnessMipmapper.generateMipmaps( child.material );

							}

						} );

						scene.add( gltf.scene );

						roughnessMipmapper.dispose();

						render();

					} );

				} );

			console.log("viewport_container-dimensions testing 1 width: " +viewport_container.offsetWidth +" height: " +viewport_container.offsetHeight);

			renderer = new THREE.WebGLRenderer( { antialias: true } );
			renderer.setPixelRatio( (viewport_container.offsetWidth - widthOffset) / viewport_container.offsetHeight );
			renderer.setSize( viewport_container.offsetWidth - widthOffset , viewport_container.offsetHeight );
			renderer.toneMapping = THREE.ACESFilmicToneMapping;
			renderer.toneMappingExposure = 1;
			renderer.outputEncoding = THREE.sRGBEncoding;
			viewport_container.appendChild( renderer.domElement );

			const pmremGenerator = new THREE.PMREMGenerator( renderer );
			pmremGenerator.compileEquirectangularShader();

			const controls = new OrbitControls( camera, renderer.domElement );
			controls.addEventListener( 'change', render ); // use if there is no animation loop
			controls.minDistance = 2;
			controls.maxDistance = 10;
			controls.target.set( 0, 0, - 0.2 );
			controls.update();

			
			// controls = new FlyControls( camera, renderer.domElement );
			// controls.movementSpeed = 1000;
			// controls.domElement = renderer.domElement;
			// controls.rollSpeed = Math.PI / 24;
			// controls.autoForward = false;
			// controls.dragToLook = false;
			// controls.update(1);

			window.addEventListener( 'resize', onResize, false );

			// feature_container = document.querySelector("#map_container");
			// feature_container.addEventListener( 'resize', onResize, false );
			
			// button1.addEventListener( 'click',moveCamera( -2.5121, 3.8016, 6.7234)); // THIS WILL NOT WORK SINCE YOU CANNOT PASS ARGUEMENTS DIRECTLY
			button1.addEventListener( 'click', function() {
				moveCamera( -4.5315, 1.5105, 7.1008);

				document.querySelector("#description_container").innerHTML = document.querySelector("#area-1_description").innerHTML
			});
			
			button2.addEventListener( 'click', function() {
				moveCamera( 1.1862, 1.3003, 8.3347);

				document.querySelector("#description_container").innerHTML = document.querySelector("#area-2_description").innerHTML
			});

			button3.addEventListener( 'click', function() {
				moveCamera( -2.6583, 1.6893, 9.7506);
				
				document.querySelector("#description_container").innerHTML = document.querySelector("#area-3_description").innerHTML
			});

			console.log("viewport_container-dimensions testing 2 width: " +viewport_container.offsetWidth +" height: " +viewport_container.offsetHeight);

		}

		function onResize() {

			// camera.aspect = window.innerWidth / window.innerHeight;
			camera.aspect = (viewport_container.offsetWidth - widthOffset) / viewport_container.offsetHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( viewport_container.offsetWidth - widthOffset, viewport_container.offsetHeight );

			render();

		}

		//

		function render() {

			renderer.render( scene, camera );
			// controls.update(1);

			// document.querySelector("#x").value="x: " +camera.position.x;
			// document.querySelector("#y").value="y: " +camera.position.y;
			// document.querySelector("#z").value="z: " +camera.position.z;
		}

		function moveCamera(x, y, z){
			camera.position.set( x, y, z);

			console.log("moved @" +x +", " +y +", " +z);

			render();
		}

	</script>
	<script src="waw.js"></script>
</html>
